<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="styles/bootstrap.min.css">
    <link rel="stylesheet" href="styles/main.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>

</head>

<body>

    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">Dashboard</a>
            <button class="btn btn-danger" id="logoutBtn">Cerrar Sesi√≥n</button>
        </div>
    </nav>

    <main class="container py-5">
        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Tus Generadores</h5>
                    </div>
                    <div class="card-body" id="generadores-container">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const initializeSupabase = async () => {
            const { createClient } = supabase; // Import createClient
            const supabaseUrl = 'https://gztsbqbqmesfrvywpyhl.supabase.co';
            const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd6dHNicWJxbWVzZnJ2eXdweWhsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzkyMDg3NDUsImV4cCI6MjA1NDc4NDc0NX0.EmRDO3s64iYw1k3OY5W44twraLnJHy6bQh3HKTtx-wI';
            return createClient(supabaseUrl, supabaseAnonKey);
        };
        // Function to load data
        const loadGeneradores = async () => {
            const supabase = await initializeSupabase();

            const { data: equipos, error } = await supabase
                .from('equipos')
                .select(`
                    id,
                    marca_genset,
                    serie_genset,
                    horometro,
                    horas_equipo,
                    clientes ( nombre )
                `)
                .order('horometro', { ascending: false });

            const container = document.getElementById('generadores-container');

            if (error) {
                container.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
                return;
            }

            if (!equipos || equipos.length === 0) {
                container.innerHTML = `<div class="alert alert-info">No hay generadores registrados</div>`;
                return;
            }

            container.innerHTML = equipos.map(equipo => `
                <div class="card mb-3">
                    <div class="card-body">
                        <h5>${equipo.marca_genset}</h5>
                        <p class="mb-1">
                            Estado: 
                            <span class="badge ${equipo.horas_equipo >= 1000 ? 'bg-warning' : 'bg-success'}">
                                ${equipo.horas_equipo >= 1000 ? 'Requiere mant.' : 'Operativo'}
                            </span>
                        </p>
                        <p class="mb-1">Cliente: ${equipo.clientes?.nombre || 'Sin cliente asignado'}</p>
                    </div>
                </div>
            `).join('');
        };

        // Verify session and load data
        (async () => {
            const supabase = await initializeSupabase();
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                loadGeneradores();
            } else {
                window.location.href = 'login.html';
            }
        })();
    </script>
</body>

</html>
